name: Validate Download Counts

on:
  pull_request:
    paths:
      - 'mods.json'
  push:
    paths:
      - 'mods.json'
    branches:
      - main

jobs:
  validate-downloads:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current version
        uses: actions/checkout@v4
        with:
          path: current

      - name: Checkout previous version
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          ref: ${{ github.event.before || 'HEAD~1' }}
          path: previous

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate download count changes
        run: |
          set -eo pipefail
          python <<'PY' | tee download_validation.log
          import json
          import sys
          from pathlib import Path


          def load_mods(path: Path) -> dict[str, dict]:
              if not path.exists():
                  return {}
              with path.open("r", encoding="utf-8") as handle:
                  data = json.load(handle)
              return {
                  mod.get("name", ""): mod
                  for mod in data.get("mods", [])
                  if mod.get("name")
              }


          current = load_mods(Path("current/mods.json"))
          previous = load_mods(Path("previous/mods.json"))

          print("Validating download count changes\n")

          if not previous:
              print("No previous mods.json found; skipping validation.")
              sys.exit(0)

          errors: list[str] = []
          warnings: list[str] = []
          updates: list[str] = []

          for name, current_mod in current.items():
              current_dl = current_mod.get("downloads", 0)
              previous_dl = previous.get(name, {}).get("downloads", 0)

              if current_dl < previous_dl:
                  errors.append(
                      f"{name}: download count decreased ({previous_dl} -> {current_dl})"
                  )
              elif current_dl > previous_dl:
                  increment = current_dl - previous_dl
                  updates.append(f"{name}: {previous_dl} -> {current_dl} (+{increment})")
                  if increment > 100:
                      warnings.append(
                          f"{name}: large increment (+{increment}); verify intended."
                      )

          if updates:
              print("Detected download count increases:")
              for line in updates:
                  print(f"  {line}")
              print()

          if warnings:
              print("Warnings:")
              for line in warnings:
                  print(f"  {line}")
              print()

          if errors:
              print("Validation failed. Downloads must not decrease:")
              for line in errors:
                  print(f"  {line}")
              sys.exit(1)

          print("Validation passed. No download count regressions detected.")
          PY

      - name: Check commit message format
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          set -euo pipefail
          COMMIT_MSG=$(git -C current log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"

          if python <<'PY'
          import json
          import sys

          with open('current/mods.json', 'r', encoding='utf-8') as handle:
              current = json.load(handle)
          with open('previous/mods.json', 'r', encoding='utf-8') as handle:
              previous = json.load(handle)

          for mod in current.get('mods', []):
              name = mod.get('name')
              if not name:
                  continue
              current_dl = mod.get('downloads', 0)
              previous_mod = next(
                  (item for item in previous.get('mods', []) if item.get('name') == name),
                  None,
              )
              if previous_mod and previous_mod.get('downloads', 0) != current_dl:
                  sys.exit(0)
          sys.exit(1)
          PY
          then
              if ! echo "$COMMIT_MSG" | grep -qiE "(increment download|download count|auto-sync)"; then
                  echo "::warning::Download counts changed but commit message does not mention it."
              else
                  echo "Commit message acknowledges download count changes."
              fi
          else
              echo "No download count changes detected; commit message check skipped."
          fi

      - name: Publish summary
        if: always()
        run: |
          {
            echo "## Download Count Validation"
            echo
            echo "Job status: ${{ job.status }}"
            if [ -f download_validation.log ]; then
              echo
              echo '```'
              cat download_validation.log
              echo '```'
            fi
          } >> "$GITHUB_STEP_SUMMARY"
